// Generated by ReScript, PLEASE EDIT WITH CARE

import * as SkipruntimeServer from "../bindings/SkipruntimeServer.res.js";
import * as Helpers from "@skipruntime/helpers";
import * as LiveHarnessServiceJs from "./LiveHarnessService.js";

let service = LiveHarnessServiceJs.service;

function resetRunStats(prim) {
  LiveHarnessServiceJs.resetRunStats();
}

function getRunStats(prim) {
  return LiveHarnessServiceJs.getRunStats();
}

let defaultOpts = {
  streaming_port: 18081,
  control_port: 18080,
  platform: "wasm",
  no_cors: undefined
};

function start(opts) {
  return SkipruntimeServer.Natural.runService(service, opts);
}

function stop(server) {
  return SkipruntimeServer.Natural.close(server);
}

let Server = {
  service: service,
  resetRunStats: resetRunStats,
  getRunStats: getRunStats,
  defaultOpts: defaultOpts,
  start: start,
  stop: stop
};

let localhost = "127.0.0.1";

function makeBroker(opts) {
  return new Helpers.SkipServiceBroker({
    host: localhost,
    streaming_port: opts.streaming_port,
    control_port: opts.control_port,
    secured: undefined
  }, undefined);
}

async function snapshot(broker, resource, label) {
  let snapshot$1 = await broker.getAll(resource, null);
  console.log(label, snapshot$1);
}

function updateInput(broker, entries) {
  return broker.update("numbers", entries);
}

let Client = {
  localhost: localhost,
  makeBroker: makeBroker,
  snapshot: snapshot,
  updateInput: updateInput
};

async function run() {
  console.log("harness: starting LiveService (wasm) on 18080/18081â€¦");
  let server = await start(defaultOpts);
  console.log("harness: service started");
  let broker = makeBroker(defaultOpts);
  LiveHarnessServiceJs.resetRunStats();
  await snapshot(broker, "numbers", "harness: initial numbers");
  await snapshot(broker, "doubled", "harness: initial doubled");
  await snapshot(broker, "sumNaive", "harness: initial sum (naive)");
  console.log("harness: run counters (naive initial)", LiveHarnessServiceJs.getRunStats());
  await broker.update("numbers", [[
      "c",
      [5]
    ]]);
  await snapshot(broker, "numbers", "harness: numbers after update");
  await snapshot(broker, "doubled", "harness: doubled after update");
  await snapshot(broker, "sumNaive", "harness: sum (naive) after update");
  console.log("harness: run counters (naive after update)", LiveHarnessServiceJs.getRunStats());
  LiveHarnessServiceJs.resetRunStats();
  await snapshot(broker, "numbers", "harness: initial numbers (inc)");
  await snapshot(broker, "doubled", "harness: initial doubled (inc)");
  await snapshot(broker, "sumInc", "harness: initial sum (inc)");
  console.log("harness: run counters (inc initial)", LiveHarnessServiceJs.getRunStats());
  await broker.update("numbers", [[
      "d",
      [7]
    ]]);
  await snapshot(broker, "numbers", "harness: numbers after update (inc)");
  await snapshot(broker, "doubled", "harness: doubled after update (inc)");
  await snapshot(broker, "sumInc", "harness: sum (inc) after update");
  console.log("harness: run counters (inc after update)", LiveHarnessServiceJs.getRunStats());
  LiveHarnessServiceJs.resetRunStats();
  await snapshot(broker, "perKeySums", "harness: per-key sums initial (two-stage)");
  await snapshot(broker, "sumOfPerKeySums", "harness: total sum initial (two-stage)");
  console.log("harness: run counters (two-stage initial)", LiveHarnessServiceJs.getRunStats());
  await broker.update("numbers", [[
      "d",
      [10]
    ]]);
  await snapshot(broker, "perKeySums", "harness: per-key sums after update (two-stage)");
  await snapshot(broker, "sumOfPerKeySums", "harness: total sum after update (two-stage)");
  console.log("harness: run counters (two-stage after update)", LiveHarnessServiceJs.getRunStats());
  await SkipruntimeServer.Natural.close(server);
  console.log("harness: service closed");
}

run();

export {
  Server,
  Client,
  run,
}
/* service Not a pure module */
